{% extends "base.html" %}

{% block title %}DEEP Research çŠ¶æ€{% endblock %}

{% block extra_css %}
<style>
.research-status-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
}

.status-card {
    background: white;
    border-radius: 15px;
    padding: 30px;
    margin-bottom: 20px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}

.status-indicator {
    display: inline-flex;
    align-items: center;
    padding: 8px 16px;
    border-radius: 20px;
    font-weight: 500;
    margin-bottom: 15px;
}

.status-available {
    background: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
}

.status-unavailable {
    background: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
}

.feature-list {
    list-style: none;
    padding: 0;
}

.feature-list li {
    padding: 10px 0;
    border-bottom: 1px solid #eee;
    display: flex;
    align-items: center;
}

.feature-list li:last-child {
    border-bottom: none;
}

.feature-icon {
    margin-right: 10px;
    font-size: 1.2em;
}

.reports-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 20px;
    margin-top: 20px;
}

.report-card {
    background: #f8f9fa;
    border-radius: 10px;
    padding: 20px;
    border: 1px solid #dee2e6;
}

.report-meta {
    font-size: 0.9em;
    color: #6c757d;
    margin-bottom: 10px;
}

.btn-group {
    display: flex;
    gap: 10px;
    margin-top: 15px;
}

.btn {
    padding: 8px 16px;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    text-decoration: none;
    display: inline-block;
    font-size: 0.9em;
}

.btn-primary {
    background: #007bff;
    color: white;
}

.btn-danger {
    background: #dc3545;
    color: white;
}

.btn-secondary {
    background: #6c757d;
    color: white;
}

.loading {
    text-align: center;
    padding: 40px;
    color: #6c757d;
}
</style>
{% endblock %}

{% block content %}
<div class="research-status-container">
    <h1 style="text-align: center; margin-bottom: 30px; color: #2c3e50;">
        ğŸ” DEEP Research ç³»ç»ŸçŠ¶æ€
    </h1>
    
    <!-- æœåŠ¡çŠ¶æ€å¡ç‰‡ -->
    <div class="status-card">
        <h2 style="margin-bottom: 20px;">æœåŠ¡çŠ¶æ€</h2>
        <div id="service-status" class="loading">
            æ­£åœ¨æ£€æŸ¥æœåŠ¡çŠ¶æ€...
        </div>
    </div>
    
    <!-- åŠŸèƒ½ä»‹ç»å¡ç‰‡ -->
    <div class="status-card">
        <h2 style="margin-bottom: 20px;">DEEP Research åŠŸèƒ½</h2>
        <p style="color: #6c757d; margin-bottom: 20px;">
            DEEP Research æ˜¯ä¸€ä¸ªåŸºäºAIçš„æ·±åº¦ç ”ç©¶ç³»ç»Ÿï¼Œèƒ½å¤Ÿè‡ªåŠ¨è¿›è¡Œå¤šæ­¥éª¤ç½‘ç»œç ”ç©¶å¹¶ç”Ÿæˆä¸“ä¸šæŠ¥å‘Šã€‚
        </p>
        
        <ul class="feature-list">
            <li>
                <span class="feature-icon">ğŸ¯</span>
                <strong>D - Define</strong>: å®šä¹‰ç ”ç©¶ç›®æ ‡å’Œè®¡åˆ’
            </li>
            <li>
                <span class="feature-icon">ğŸ”</span>
                <strong>E - Explore</strong>: æ¢ç´¢å¤šä¸ªä¿¡æ¯ç»´åº¦
            </li>
            <li>
                <span class="feature-icon">âœ…</span>
                <strong>E - Evaluate</strong>: è¯„ä¼°ä¿¡æ¯æºå’Œè¯æ®
            </li>
            <li>
                <span class="feature-icon">ğŸ“‹</span>
                <strong>P - Present</strong>: å‘ˆç°ç»¼åˆç ”ç©¶å‘ç°
            </li>
        </ul>
    </div>
    
    <!-- ç ”ç©¶æŠ¥å‘Šåˆ—è¡¨ -->
    <div class="status-card">
        <h2 style="margin-bottom: 20px;">å·²ä¿å­˜çš„ç ”ç©¶æŠ¥å‘Š</h2>
        <div id="reports-list" class="loading">
            æ­£åœ¨åŠ è½½æŠ¥å‘Šåˆ—è¡¨...
        </div>
    </div>
    
    <!-- æµ‹è¯•ç ”ç©¶åŠŸèƒ½ -->
    <div class="status-card">
        <h2 style="margin-bottom: 20px;">æµ‹è¯•ç ”ç©¶åŠŸèƒ½</h2>
        <p style="color: #6c757d; margin-bottom: 20px;">
            è¾“å…¥ä¸€ä¸ªä¸»é¢˜æ¥æµ‹è¯•DEEP ResearchåŠŸèƒ½ï¼š
        </p>
        
        <div style="display: flex; gap: 10px; align-items: center;">
            <input type="text" id="test-topic" placeholder="ä¾‹å¦‚ï¼šäººå·¥æ™ºèƒ½å‘å±•è¶‹åŠ¿" 
                   style="flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
            <button onclick="testResearch()" class="btn btn-primary" id="test-btn">
                å¼€å§‹ç ”ç©¶
            </button>
        </div>
        
        <div id="test-result" style="margin-top: 20px; display: none;"></div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// é¡µé¢åŠ è½½æ—¶æ£€æŸ¥æœåŠ¡çŠ¶æ€
document.addEventListener('DOMContentLoaded', function() {
    checkServiceStatus();
    loadReportsList();
});

async function checkServiceStatus() {
    try {
        const response = await fetch('/api/research/status');
        const data = await response.json();
        
        const statusContainer = document.getElementById('service-status');
        
        if (data.available) {
            statusContainer.innerHTML = `
                <div class="status-indicator status-available">
                    âœ… DEEP Research æœåŠ¡å¯ç”¨
                </div>
                <div style="margin-top: 15px;">
                    <p><strong>Tavily API:</strong> ${data.tavily_configured ? 'å·²é…ç½®' : 'æœªé…ç½®'}</p>
                    <p><strong>AI Provider:</strong> ${data.status.ai_provider_type}</p>
                    <p><strong>æœ€å¤§æœç´¢ç»“æœ:</strong> ${data.status.max_results}</p>
                    <p><strong>æœç´¢æ·±åº¦:</strong> ${data.status.search_depth}</p>
                </div>
            `;
        } else {
            statusContainer.innerHTML = `
                <div class="status-indicator status-unavailable">
                    âŒ DEEP Research æœåŠ¡ä¸å¯ç”¨
                </div>
                <div style="margin-top: 15px;">
                    <p><strong>Tavily API:</strong> ${data.tavily_configured ? 'å·²é…ç½®' : 'æœªé…ç½®'}</p>
                    <p style="color: #dc3545;">è¯·æ£€æŸ¥ Tavily API å¯†é’¥é…ç½®</p>
                </div>
            `;
        }
    } catch (error) {
        document.getElementById('service-status').innerHTML = `
            <div class="status-indicator status-unavailable">
                âŒ æ— æ³•è¿æ¥åˆ°ç ”ç©¶æœåŠ¡
            </div>
            <p style="color: #dc3545; margin-top: 15px;">é”™è¯¯: ${error.message}</p>
        `;
    }
}

async function loadReportsList() {
    try {
        const response = await fetch('/api/research/reports');
        const data = await response.json();
        
        const reportsContainer = document.getElementById('reports-list');
        
        if (data.success && data.reports.length > 0) {
            const reportsHtml = data.reports.map(report => `
                <div class="report-card">
                    <h4 style="margin-bottom: 10px;">${report.filename}</h4>
                    <div class="report-meta">
                        <p>å¤§å°: ${(report.size / 1024).toFixed(1)} KB</p>
                        <p>åˆ›å»ºæ—¶é—´: ${new Date(report.created).toLocaleString()}</p>
                    </div>
                    <div class="btn-group">
                        <button onclick="deleteReport('${report.filename}')" class="btn btn-danger">
                            åˆ é™¤
                        </button>
                    </div>
                </div>
            `).join('');
            
            reportsContainer.innerHTML = `
                <p style="color: #6c757d; margin-bottom: 20px;">
                    å…±æ‰¾åˆ° ${data.total_count} ä¸ªç ”ç©¶æŠ¥å‘Šï¼Œä¿å­˜åœ¨: ${data.reports_directory}
                </p>
                <div class="reports-grid">
                    ${reportsHtml}
                </div>
            `;
        } else {
            reportsContainer.innerHTML = `
                <p style="color: #6c757d; text-align: center; padding: 40px;">
                    æš‚æ— ä¿å­˜çš„ç ”ç©¶æŠ¥å‘Š
                </p>
            `;
        }
    } catch (error) {
        document.getElementById('reports-list').innerHTML = `
            <p style="color: #dc3545; text-align: center; padding: 40px;">
                åŠ è½½æŠ¥å‘Šåˆ—è¡¨å¤±è´¥: ${error.message}
            </p>
        `;
    }
}

async function testResearch() {
    const topic = document.getElementById('test-topic').value.trim();
    if (!topic) {
        alert('è¯·è¾“å…¥ç ”ç©¶ä¸»é¢˜');
        return;
    }
    
    const testBtn = document.getElementById('test-btn');
    const resultDiv = document.getElementById('test-result');
    
    testBtn.disabled = true;
    testBtn.textContent = 'ç ”ç©¶ä¸­...';
    resultDiv.style.display = 'block';
    resultDiv.innerHTML = '<p style="color: #007bff;">æ­£åœ¨è¿›è¡ŒDEEPç ”ç©¶ï¼Œè¯·ç¨å€™...</p>';
    
    try {
        const response = await fetch('/api/research/conduct', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: `topic=${encodeURIComponent(topic)}&language=zh`
        });
        
        const data = await response.json();
        
        if (data.success) {
            resultDiv.innerHTML = `
                <div style="background: #d4edda; padding: 20px; border-radius: 10px; border: 1px solid #c3e6cb;">
                    <h4 style="color: #155724; margin-bottom: 15px;">âœ… ç ”ç©¶å®Œæˆ</h4>
                    <p><strong>ä¸»é¢˜:</strong> ${data.report.topic}</p>
                    <p><strong>è€—æ—¶:</strong> ${data.report.total_duration.toFixed(2)} ç§’</p>
                    <p><strong>ä¿¡æ¯æº:</strong> ${data.report.sources_count} ä¸ª</p>
                    <p><strong>ç ”ç©¶æ­¥éª¤:</strong> ${data.report.steps_count} ä¸ª</p>
                    ${data.report_path ? `<p><strong>æŠ¥å‘Šå·²ä¿å­˜:</strong> ${data.report_path}</p>` : ''}
                    
                    <div style="margin-top: 15px;">
                        <h5>æ‰§è¡Œæ‘˜è¦:</h5>
                        <p style="background: white; padding: 10px; border-radius: 5px;">${data.report.executive_summary}</p>
                    </div>
                </div>
            `;
            
            // åˆ·æ–°æŠ¥å‘Šåˆ—è¡¨
            loadReportsList();
        } else {
            throw new Error(data.message || 'ç ”ç©¶å¤±è´¥');
        }
    } catch (error) {
        resultDiv.innerHTML = `
            <div style="background: #f8d7da; padding: 20px; border-radius: 10px; border: 1px solid #f5c6cb;">
                <h4 style="color: #721c24; margin-bottom: 15px;">âŒ ç ”ç©¶å¤±è´¥</h4>
                <p style="color: #721c24;">${error.message}</p>
            </div>
        `;
    } finally {
        testBtn.disabled = false;
        testBtn.textContent = 'å¼€å§‹ç ”ç©¶';
    }
}

async function deleteReport(filename) {
    if (!confirm(`ç¡®å®šè¦åˆ é™¤æŠ¥å‘Š "${filename}" å—ï¼Ÿ`)) {
        return;
    }
    
    try {
        const response = await fetch(`/api/research/reports/${encodeURIComponent(filename)}`, {
            method: 'DELETE'
        });
        
        const data = await response.json();
        
        if (data.success) {
            alert('æŠ¥å‘Šåˆ é™¤æˆåŠŸ');
            loadReportsList();
        } else {
            throw new Error(data.message || 'åˆ é™¤å¤±è´¥');
        }
    } catch (error) {
        alert(`åˆ é™¤æŠ¥å‘Šå¤±è´¥: ${error.message}`);
    }
}
</script>
{% endblock %}
