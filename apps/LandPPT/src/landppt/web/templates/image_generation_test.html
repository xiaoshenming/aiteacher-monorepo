{% extends "base.html" %}

{% block title %}å›¾ç‰‡ç”Ÿæˆæµ‹è¯• - LandPPT{% endblock %}

{% block content %}
<div class="image-test-page" style="max-width: 1200px; margin: 0 auto; padding: 20px;">
    <!-- é¡µé¢æ ‡é¢˜ -->
    <div class="page-hero" style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); padding: 24px 28px; border-radius: 16px; margin-bottom: 30px; border: 1px solid rgba(17, 17, 17, 0.12);">
        <h2 style="color: #111111; margin: 0 0 8px;">ğŸ¨ AIå›¾ç‰‡ç”Ÿæˆæµ‹è¯•</h2>
        <p style="color: #5a5a5a; margin: 0;">æµ‹è¯•å„ç§AIå›¾ç‰‡ç”Ÿæˆæä¾›å•†çš„åŠŸèƒ½å’Œæ•ˆæœ</p>
    </div>

    <!-- æä¾›è€…çŠ¶æ€ -->
    <div class="card" style="background: white; padding: 25px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.08); margin-bottom: 30px; border: 1px solid #e9ecef;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h3 style="color: #111111; margin: 0;">æä¾›è€…çŠ¶æ€</h3>
            <button onclick="loadProviderStatus()" style="background: #f8f9fa; border: 1px solid #dcdcdc; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 0.9em;">
                ğŸ”„ åˆ·æ–°çŠ¶æ€
            </button>
        </div>
        <div id="status-cards" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px;">
            <!-- çŠ¶æ€å¡ç‰‡å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
            <div style="text-align: center; padding: 20px; color: #6c757d;">åŠ è½½ä¸­...</div>
        </div>
    </div>

    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
        <!-- å·¦ä¾§ï¼šå›¾ç‰‡ç”Ÿæˆè¡¨å• -->
        <div class="card" style="background: white; padding: 25px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.08); border: 1px solid #e9ecef;">
            <h3 style="color: #111111; margin: 0 0 20px;">ç”Ÿæˆå›¾ç‰‡</h3>

            <form id="generation-form">
                <!-- æç¤ºè¯è¾“å…¥ -->
                <div style="margin-bottom: 20px;">
                    <label for="prompt" style="display: block; margin-bottom: 8px; font-weight: 600; color: #495057;">æç¤ºè¯ï¼š</label>
                    <textarea id="prompt" name="prompt" rows="4"
                             style="width: 100%; padding: 12px; border: 2px solid #dcdcdc; border-radius: 8px; font-size: 14px; resize: vertical; transition: border-color 0.3s;"
                             placeholder="æè¿°æ‚¨æƒ³è¦ç”Ÿæˆçš„å›¾ç‰‡ï¼Œä¾‹å¦‚ï¼šä¸€åªå¯çˆ±çš„æ©˜çŒ«ååœ¨çª—å°ä¸Šï¼Œé˜³å…‰é€è¿‡çª—æˆ·ç…§è¿›æ¥ï¼Œæ¸©é¦¨çš„å®¤å†…åœºæ™¯"></textarea>
                </div>

                <!-- æä¾›è€…é€‰æ‹© -->
                <div style="margin-bottom: 20px;">
                    <label for="provider" style="display: block; margin-bottom: 8px; font-weight: 600; color: #495057;">AIæä¾›è€…ï¼š</label>
                    <select id="provider" name="provider"
                            style="width: 100%; padding: 12px; border: 2px solid #dcdcdc; border-radius: 8px; font-size: 14px; background: white; cursor: pointer;">
                        <option value="">é€‰æ‹©æä¾›è€…...</option>
                        <optgroup label="AIå›¾ç‰‡ç”Ÿæˆ">
                            <option value="dalle">ğŸ¨ DALL-E 3 (OpenAI)</option>
                            <option value="openai_image">ğŸ–¼ï¸ OpenAI å›¾ç‰‡ç”Ÿæˆ (è‡ªå®šä¹‰ç«¯ç‚¹)</option>
                            <option value="gemini">âœ¨ Gemini (Google)</option>
                            <option value="siliconflow">âš¡ SiliconFlow (Kolors)</option>
                            <option value="pollinations">ğŸŒ¸ Pollinations (å…è´¹)</option>
                            <option value="stable_diffusion">ğŸ­ Stable Diffusion</option>
                        </optgroup>
                    </select>
                </div>

                <!-- å°ºå¯¸é€‰æ‹© -->
                <div style="margin-bottom: 20px;">
                    <label for="size" style="display: block; margin-bottom: 8px; font-weight: 600; color: #495057;">å›¾ç‰‡å°ºå¯¸ï¼š</label>
                    <select id="size" name="size"
                            style="width: 100%; padding: 12px; border: 2px solid #dcdcdc; border-radius: 8px; font-size: 14px; background: white; cursor: pointer;">
                        <option value="1024x1024">1024Ã—1024 (æ­£æ–¹å½¢)</option>
                        <option value="1792x1024" selected>1792Ã—1024 (16:9 æ¨ªå‘ï¼Œé€‚åˆPPT)</option>
                        <option value="1024x1792">1024Ã—1792 (9:16 ç«–å‘)</option>
                        <option value="1536x1024">1536Ã—1024 (3:2 æ¨ªå‘)</option>
                        <option value="1024x1536">1024Ã—1536 (2:3 ç«–å‘)</option>
                    </select>
                </div>

                <!-- è´¨é‡é€‰æ‹© -->
                <div style="margin-bottom: 20px;">
                    <label for="quality" style="display: block; margin-bottom: 8px; font-weight: 600; color: #495057;">å›¾ç‰‡è´¨é‡ï¼š</label>
                    <select id="quality" name="quality"
                            style="width: 100%; padding: 12px; border: 2px solid #dcdcdc; border-radius: 8px; font-size: 14px; background: white; cursor: pointer;">
                        <option value="standard">æ ‡å‡†è´¨é‡</option>
                        <option value="hd">é«˜æ¸…è´¨é‡ (HD)</option>
                    </select>
                </div>

                <!-- ç”ŸæˆæŒ‰é’® -->
                <button type="submit" id="generate-btn"
                        style="width: 100%; background: linear-gradient(135deg, #0f0f0f 0%, #2a2a2a 100%);
                               color: white; border: none; padding: 15px; border-radius: 8px;
                               font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s ease;">
                    ğŸ¨ ç”Ÿæˆå›¾ç‰‡
                </button>
            </form>

            <!-- ç”Ÿæˆè¿›åº¦ -->
            <div id="generation-progress" style="display: none; margin-top: 20px; padding: 20px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #111111;">
                <div style="text-align: center;">
                    <div style="font-size: 2em; margin-bottom: 15px;">â³</div>
                    <div id="progress-text" style="color: #495057; margin-bottom: 15px;">æ­£åœ¨ç”Ÿæˆå›¾ç‰‡ï¼Œè¯·ç¨å€™...</div>
                    <div style="width: 100%; background: #e9ecef; border-radius: 10px; overflow: hidden;">
                        <div id="progress-bar" style="width: 0%; height: 8px; background: linear-gradient(90deg, #0f0f0f, #2a2a2a); transition: width 0.3s ease;"></div>
                    </div>
                    <div id="progress-time" style="color: #6c757d; font-size: 0.85em; margin-top: 10px;">å·²ç”¨æ—¶: 0ç§’</div>
                </div>
            </div>
        </div>

        <!-- å³ä¾§ï¼šç”Ÿæˆç»“æœ -->
        <div class="card" style="background: white; padding: 25px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.08); border: 1px solid #e9ecef;">
            <h3 style="color: #111111; margin: 0 0 20px;">ç”Ÿæˆç»“æœ</h3>
            <div id="result-content" style="min-height: 300px; display: flex; align-items: center; justify-content: center;">
                <div style="text-align: center; color: #6c757d;">
                    <div style="font-size: 3em; margin-bottom: 15px;">ğŸ–¼ï¸</div>
                    <p>ç”Ÿæˆçš„å›¾ç‰‡å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ</p>
                    <p style="font-size: 0.85em;">é€‰æ‹©æä¾›è€…å¹¶è¾“å…¥æç¤ºè¯åç‚¹å‡»ç”Ÿæˆ</p>
                </div>
            </div>
        </div>
    </div>

    <!-- å†å²è®°å½• -->
    <div class="card" style="background: white; padding: 25px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.08); margin-top: 30px; border: 1px solid #e9ecef;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h3 style="color: #111111; margin: 0;">ç”Ÿæˆå†å²</h3>
            <button onclick="clearHistory()" style="background: #f8f9fa; border: 1px solid #dcdcdc; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 0.9em;">
                ğŸ—‘ï¸ æ¸…ç©ºå†å²
            </button>
        </div>
        <div id="history-container" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px;">
            <div style="text-align: center; padding: 40px; color: #6c757d; grid-column: 1 / -1;">
                æš‚æ— ç”Ÿæˆå†å²
            </div>
        </div>
    </div>
</div>


<style>
.image-test-page input:focus,
.image-test-page select:focus,
.image-test-page textarea:focus {
    border-color: #0f0f0f;
    box-shadow: 0 0 0 3px rgba(0, 0, 0, 0.12);
    outline: none;
}

.image-test-page button:hover:not(:disabled) {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
}

.image-test-page button:disabled {
    opacity: 0.6;
    cursor: not-allowed;
}

.provider-card {
    background: #f8f9fa;
    border: 2px solid #e9ecef;
    border-radius: 10px;
    padding: 15px;
    text-align: center;
    transition: all 0.3s ease;
}

.provider-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

.provider-card.available {
    background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
    border-color: #28a745;
}

.provider-card.unavailable {
    background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
    border-color: #dc3545;
}

.history-item {
    background: #f8f9fa;
    border-radius: 8px;
    overflow: hidden;
    cursor: pointer;
    transition: all 0.3s ease;
}

.history-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}

.history-item img {
    width: 100%;
    height: 150px;
    object-fit: cover;
}

.history-item-info {
    padding: 10px;
    font-size: 0.85em;
}

@media (max-width: 768px) {
    .image-test-page > div[style*="grid-template-columns: 1fr 1fr"] {
        grid-template-columns: 1fr !important;
    }
}
</style>


<script>
// ç”Ÿæˆå†å²
let generationHistory = [];

// é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
    loadProviderStatus();
    loadHistory();
});

// åŠ è½½æä¾›è€…çŠ¶æ€
async function loadProviderStatus() {
    const statusCards = document.getElementById('status-cards');
    statusCards.innerHTML = '<div style="text-align: center; padding: 20px; color: #6c757d; grid-column: 1 / -1;">åŠ è½½ä¸­...</div>';

    try {
        const response = await fetch('/api/image/status');
        const data = await response.json();

        statusCards.innerHTML = '';

        // æ‰€æœ‰æ”¯æŒçš„æä¾›è€…
        const providers = [
            { key: 'dalle', name: 'DALL-E 3', icon: 'ğŸ¨', desc: 'OpenAI' },
            { key: 'openai_image', name: 'OpenAIå›¾ç‰‡', icon: 'ğŸ–¼ï¸', desc: 'è‡ªå®šä¹‰ç«¯ç‚¹' },
            { key: 'gemini', name: 'Gemini', icon: 'âœ¨', desc: 'Google' },
            { key: 'siliconflow', name: 'SiliconFlow', icon: 'âš¡', desc: 'Kolors' },
            { key: 'pollinations', name: 'Pollinations', icon: 'ğŸŒ¸', desc: 'å…è´¹æœåŠ¡' },
            { key: 'stable_diffusion', name: 'Stable Diffusion', icon: 'ğŸ­', desc: 'Stability AI' }
        ];

        providers.forEach(provider => {
            const isAvailable = data.available_providers && data.available_providers.includes(provider.key);
            const card = document.createElement('div');
            card.className = `provider-card ${isAvailable ? 'available' : 'unavailable'}`;

            card.innerHTML = `
                <div style="font-size: 2em; margin-bottom: 8px;">${provider.icon}</div>
                <div style="font-weight: 600; color: #111111; margin-bottom: 4px;">${provider.name}</div>
                <div style="font-size: 0.8em; color: #6c757d; margin-bottom: 8px;">${provider.desc}</div>
                <div style="font-size: 0.85em; font-weight: 500; color: ${isAvailable ? '#155724' : '#721c24'};">
                    ${isAvailable ? 'âœ… å¯ç”¨' : 'âŒ æœªé…ç½®'}
                </div>
            `;

            statusCards.appendChild(card);
        });

    } catch (error) {
        console.error('Failed to load provider status:', error);
        statusCards.innerHTML = `
            <div style="text-align: center; padding: 20px; color: #dc3545; grid-column: 1 / -1;">
                âŒ åŠ è½½çŠ¶æ€å¤±è´¥: ${error.message}
            </div>
        `;
    }
}


// å¤„ç†è¡¨å•æäº¤
document.getElementById('generation-form').addEventListener('submit', async function(e) {
    e.preventDefault();

    const formData = new FormData(e.target);
    const prompt = formData.get('prompt');
    const provider = formData.get('provider');
    const size = formData.get('size');
    const quality = formData.get('quality');

    if (!prompt.trim()) {
        showNotification('è¯·è¾“å…¥æç¤ºè¯', 'error');
        return;
    }

    if (!provider) {
        showNotification('è¯·é€‰æ‹©AIæä¾›è€…', 'error');
        return;
    }

    // è§£æå°ºå¯¸
    const [width, height] = size.split('x').map(Number);

    // æ˜¾ç¤ºè¿›åº¦
    showProgress();

    const startTime = Date.now();
    let timerInterval;

    // æ›´æ–°è®¡æ—¶å™¨
    timerInterval = setInterval(() => {
        const elapsed = Math.floor((Date.now() - startTime) / 1000);
        document.getElementById('progress-time').textContent = `å·²ç”¨æ—¶: ${elapsed}ç§’`;
    }, 1000);

    try {
        const response = await fetch('/api/image/generate', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                prompt: prompt,
                provider: provider,
                width: width,
                height: height,
                quality: quality
            })
        });

        const data = await response.json();

        clearInterval(timerInterval);
        const totalTime = Math.floor((Date.now() - startTime) / 1000);

        if (data.success) {
            showResult(data, prompt, provider, totalTime);
            addToHistory(data, prompt, provider);
        } else {
            showError(data.message || 'ç”Ÿæˆå¤±è´¥');
        }

    } catch (error) {
        clearInterval(timerInterval);
        console.error('Generation failed:', error);
        showError('ç”Ÿæˆå¤±è´¥: ' + error.message);
    } finally {
        hideProgress();
    }
});

// æ˜¾ç¤ºè¿›åº¦
function showProgress() {
    document.getElementById('generation-progress').style.display = 'block';
    document.getElementById('generate-btn').disabled = true;
    document.getElementById('generate-btn').textContent = 'â³ ç”Ÿæˆä¸­...';
    document.getElementById('progress-time').textContent = 'å·²ç”¨æ—¶: 0ç§’';

    // æ¨¡æ‹Ÿè¿›åº¦æ¡åŠ¨ç”»
    let progress = 0;
    const progressBar = document.getElementById('progress-bar');
    const interval = setInterval(() => {
        progress += Math.random() * 8;
        if (progress > 90) progress = 90;
        progressBar.style.width = progress + '%';
    }, 500);

    window.progressInterval = interval;
}

// éšè—è¿›åº¦
function hideProgress() {
    document.getElementById('generation-progress').style.display = 'none';
    document.getElementById('generate-btn').disabled = false;
    document.getElementById('generate-btn').textContent = 'ğŸ¨ ç”Ÿæˆå›¾ç‰‡';
    document.getElementById('progress-bar').style.width = '100%';

    if (window.progressInterval) {
        clearInterval(window.progressInterval);
    }
}


// æ˜¾ç¤ºç»“æœ
function showResult(data, prompt, provider, totalTime) {
    const resultContent = document.getElementById('result-content');

    const providerNames = {
        'dalle': 'DALL-E 3',
        'openai_image': 'OpenAI å›¾ç‰‡ç”Ÿæˆ',
        'gemini': 'Gemini',
        'siliconflow': 'SiliconFlow',
        'pollinations': 'Pollinations',
        'stable_diffusion': 'Stable Diffusion'
    };

    const imagePath = data.image_path || data.image_info?.local_path || '';
    // å¤„ç†å›¾ç‰‡URLï¼šå¦‚æœæ˜¯å®Œæ•´URLåˆ™ç›´æ¥ä½¿ç”¨ï¼Œå¦‚æœæ˜¯ç›¸å¯¹è·¯å¾„åˆ™æ·»åŠ å‰ç¼€
    let imageUrl = imagePath;
    if (imagePath.startsWith('http://') || imagePath.startsWith('https://')) {
        // å®Œæ•´URLï¼Œæå–è·¯å¾„éƒ¨åˆ†ï¼ˆå»æ‰åŸŸåï¼‰
        try {
            const url = new URL(imagePath);
            imageUrl = url.pathname;
        } catch (e) {
            imageUrl = imagePath;
        }
    } else if (!imagePath.startsWith('/')) {
        imageUrl = '/images/' + imagePath;
    }

    resultContent.innerHTML = `
        <div style="margin-bottom: 20px; padding: 15px; background: #d4edda; border-radius: 8px; border-left: 4px solid #28a745;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <span style="color: #155724; font-weight: 600;">âœ… ç”ŸæˆæˆåŠŸ</span>
                <span style="color: #6c757d; font-size: 0.85em;">ç”¨æ—¶: ${totalTime}ç§’</span>
            </div>
            <div style="font-size: 0.9em; color: #495057;">
                <strong>æä¾›è€…ï¼š</strong> ${providerNames[provider] || provider}<br>
                <strong>æç¤ºè¯ï¼š</strong> ${prompt.length > 100 ? prompt.substring(0, 100) + '...' : prompt}
            </div>
        </div>
        <div style="text-align: center; margin-bottom: 20px;">
            <img src="${imageUrl}" alt="Generated Image"
                 style="max-width: 100%; height: auto; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.2);"
                 onerror="this.onerror=null; this.src='/static/images/placeholder.svg'; this.alt='å›¾ç‰‡åŠ è½½å¤±è´¥';">
        </div>
        <div style="display: flex; gap: 10px; justify-content: center;">
            <a href="${imageUrl}" download style="background: #0f0f0f; color: white; padding: 10px 20px; text-decoration: none; border-radius: 6px; font-weight: 500; display: inline-flex; align-items: center; gap: 8px;">
                ğŸ“¥ ä¸‹è½½å›¾ç‰‡
            </a>
            <button onclick="copyImageUrl('${imageUrl}')" style="background: #f8f9fa; color: #111111; padding: 10px 20px; border: 1px solid #dcdcdc; border-radius: 6px; font-weight: 500; cursor: pointer; display: inline-flex; align-items: center; gap: 8px;">
                ğŸ“‹ å¤åˆ¶é“¾æ¥
            </button>
        </div>
    `;
}

// æ˜¾ç¤ºé”™è¯¯
function showError(message) {
    const resultContent = document.getElementById('result-content');

    resultContent.innerHTML = `
        <div style="padding: 30px; text-align: center;">
            <div style="font-size: 3em; margin-bottom: 15px;">âŒ</div>
            <div style="background: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; padding: 20px; border-radius: 8px;">
                <strong>ç”Ÿæˆå¤±è´¥</strong><br>
                <span style="font-size: 0.9em;">${message}</span>
            </div>
            <p style="color: #6c757d; margin-top: 15px; font-size: 0.9em;">
                è¯·æ£€æŸ¥æä¾›è€…é…ç½®æ˜¯å¦æ­£ç¡®ï¼Œæˆ–å°è¯•å…¶ä»–æä¾›è€…
            </p>
        </div>
    `;
}

// å¤åˆ¶å›¾ç‰‡URL
function copyImageUrl(url) {
    const fullUrl = window.location.origin + url;
    navigator.clipboard.writeText(fullUrl).then(() => {
        showNotification('é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
    }).catch(err => {
        showNotification('å¤åˆ¶å¤±è´¥: ' + err.message, 'error');
    });
}


// æ·»åŠ åˆ°å†å²è®°å½•
function addToHistory(data, prompt, provider) {
    const imagePath = data.image_path || data.image_info?.local_path || '';
    // å¤„ç†å›¾ç‰‡URLï¼šå¦‚æœæ˜¯å®Œæ•´URLåˆ™æå–è·¯å¾„éƒ¨åˆ†
    let imageUrl = imagePath;
    if (imagePath.startsWith('http://') || imagePath.startsWith('https://')) {
        try {
            const url = new URL(imagePath);
            imageUrl = url.pathname;
        } catch (e) {
            imageUrl = imagePath;
        }
    } else if (!imagePath.startsWith('/')) {
        imageUrl = '/images/' + imagePath;
    }

    const historyItem = {
        id: Date.now(),
        imageUrl: imageUrl,
        prompt: prompt,
        provider: provider,
        timestamp: new Date().toLocaleString()
    };

    generationHistory.unshift(historyItem);

    // æœ€å¤šä¿ç•™20æ¡è®°å½•
    if (generationHistory.length > 20) {
        generationHistory = generationHistory.slice(0, 20);
    }

    // ä¿å­˜åˆ°localStorage
    try {
        localStorage.setItem('imageGenerationHistory', JSON.stringify(generationHistory));
    } catch (e) {
        console.warn('Failed to save history to localStorage:', e);
    }

    renderHistory();
}

// åŠ è½½å†å²è®°å½•
function loadHistory() {
    try {
        const saved = localStorage.getItem('imageGenerationHistory');
        if (saved) {
            generationHistory = JSON.parse(saved);
            renderHistory();
        }
    } catch (e) {
        console.warn('Failed to load history from localStorage:', e);
    }
}

// æ¸²æŸ“å†å²è®°å½•
function renderHistory() {
    const container = document.getElementById('history-container');

    if (generationHistory.length === 0) {
        container.innerHTML = `
            <div style="text-align: center; padding: 40px; color: #6c757d; grid-column: 1 / -1;">
                æš‚æ— ç”Ÿæˆå†å²
            </div>
        `;
        return;
    }

    const providerNames = {
        'dalle': 'DALL-E',
        'openai_image': 'OpenAI',
        'gemini': 'Gemini',
        'siliconflow': 'SiliconFlow',
        'pollinations': 'Pollinations',
        'stable_diffusion': 'SD'
    };

    container.innerHTML = generationHistory.map(item => `
        <div class="history-item" onclick="viewHistoryItem(${item.id})">
            <img src="${item.imageUrl}" alt="Generated Image" onerror="this.src='/static/images/placeholder.svg';">
            <div class="history-item-info">
                <div style="font-weight: 500; color: #111111; margin-bottom: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                    ${item.prompt.substring(0, 30)}${item.prompt.length > 30 ? '...' : ''}
                </div>
                <div style="color: #6c757d; display: flex; justify-content: space-between;">
                    <span>${providerNames[item.provider] || item.provider}</span>
                    <span>${item.timestamp.split(' ')[1] || item.timestamp}</span>
                </div>
            </div>
        </div>
    `).join('');
}

// æŸ¥çœ‹å†å²è®°å½•é¡¹
function viewHistoryItem(id) {
    const item = generationHistory.find(h => h.id === id);
    if (!item) return;

    // å¡«å……è¡¨å•
    document.getElementById('prompt').value = item.prompt;
    document.getElementById('provider').value = item.provider;

    // æ˜¾ç¤ºå›¾ç‰‡
    showResult({ image_path: item.imageUrl }, item.prompt, item.provider, 0);

    // æ»šåŠ¨åˆ°é¡¶éƒ¨
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

// æ¸…ç©ºå†å²è®°å½•
function clearHistory() {
    if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰ç”Ÿæˆå†å²å—ï¼Ÿ')) {
        generationHistory = [];
        try {
            localStorage.removeItem('imageGenerationHistory');
        } catch (e) {
            console.warn('Failed to clear history from localStorage:', e);
        }
        renderHistory();
        showNotification('å†å²è®°å½•å·²æ¸…ç©º', 'success');
    }
}


// æ˜¾ç¤ºé€šçŸ¥
function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 15px 20px;
        border-radius: 8px;
        color: white;
        font-weight: 600;
        z-index: 10000;
        max-width: 400px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        transform: translateX(100%);
        transition: transform 0.3s ease;
    `;

    switch (type) {
        case 'success':
            notification.style.background = 'linear-gradient(135deg, #0f0f0f 0%, #2a2a2a 100%)';
            break;
        case 'error':
            notification.style.background = 'linear-gradient(135deg, #dc3545 0%, #c82333 100%)';
            break;
        default:
            notification.style.background = 'linear-gradient(135deg, #2a2a2a 0%, #0f0f0f 100%)';
    }

    notification.textContent = message;
    document.body.appendChild(notification);

    setTimeout(() => {
        notification.style.transform = 'translateX(0)';
    }, 100);

    setTimeout(() => {
        notification.style.transform = 'translateX(100%)';
        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 300);
    }, 3000);
}

// æ ¹æ®æä¾›è€…æ›´æ–°å¯ç”¨çš„å°ºå¯¸é€‰é¡¹
document.getElementById('provider').addEventListener('change', function() {
    const provider = this.value;
    const sizeSelect = document.getElementById('size');
    const qualitySelect = document.getElementById('quality');

    // æ ¹æ®æä¾›è€…è°ƒæ•´å¯ç”¨é€‰é¡¹
    if (provider === 'dalle' || provider === 'openai_image') {
        // DALL-E æ”¯æŒçš„å°ºå¯¸
        sizeSelect.innerHTML = `
            <option value="1024x1024">1024Ã—1024 (æ­£æ–¹å½¢)</option>
            <option value="1792x1024" selected>1792Ã—1024 (16:9 æ¨ªå‘)</option>
            <option value="1024x1792">1024Ã—1792 (9:16 ç«–å‘)</option>
        `;
        qualitySelect.disabled = false;
    } else if (provider === 'gemini') {
        // Gemini æ”¯æŒçš„å°ºå¯¸
        sizeSelect.innerHTML = `
            <option value="1024x1024">1024Ã—1024 (æ­£æ–¹å½¢)</option>
            <option value="1792x1024" selected>1792Ã—1024 (16:9 æ¨ªå‘ï¼Œé€‚åˆPPT)</option>
            <option value="1024x1792">1024Ã—1792 (9:16 ç«–å‘)</option>
            <option value="1536x1024">1536Ã—1024 (3:2 æ¨ªå‘)</option>
            <option value="1024x1536">1024Ã—1536 (2:3 ç«–å‘)</option>
            <option value="1280x720">1280Ã—720 (HD)</option>
        `;
        qualitySelect.disabled = true;
    } else if (provider === 'pollinations') {
        // Pollinations æ”¯æŒæ›´å¤šå°ºå¯¸
        sizeSelect.innerHTML = `
            <option value="1024x1024">1024Ã—1024 (æ­£æ–¹å½¢)</option>
            <option value="1792x1024" selected>1792Ã—1024 (16:9 æ¨ªå‘)</option>
            <option value="1024x1792">1024Ã—1792 (9:16 ç«–å‘)</option>
            <option value="1280x720">1280Ã—720 (HD)</option>
            <option value="1920x1080">1920Ã—1080 (Full HD)</option>
        `;
        qualitySelect.disabled = true;
    } else {
        // é»˜è®¤å°ºå¯¸é€‰é¡¹
        sizeSelect.innerHTML = `
            <option value="1024x1024">1024Ã—1024 (æ­£æ–¹å½¢)</option>
            <option value="1792x1024" selected>1792Ã—1024 (16:9 æ¨ªå‘)</option>
            <option value="1024x1792">1024Ã—1792 (9:16 ç«–å‘)</option>
            <option value="1536x1024">1536Ã—1024 (3:2 æ¨ªå‘)</option>
            <option value="1024x1536">1024Ã—1536 (2:3 ç«–å‘)</option>
        `;
        qualitySelect.disabled = false;
    }
});
</script>
{% endblock %}
